<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Prova | Next Level Podcast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { aec: { blue: '#0032A1', dark: '#001E4B', pink: '#ec4899', pinkDark: '#be185d' } }
                }
            }
        }
    </script>
    <style>
        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .gradient-text {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="bg-slate-950 text-white min-h-screen font-sans">

    <!-- Navbar -->
    <nav class="sticky top-0 z-40 bg-slate-900/90 border-b border-slate-800 backdrop-blur-md">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a href="dashboard.html" class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-aec-pink text-2xl">podcasts</span>
                    <span class="font-bold">Next <span class="gradient-text">Level</span></span>
                </a>

                <div id="timer" class="hidden bg-slate-800 px-4 py-2 rounded-lg text-sm font-mono">
                    <span class="material-symbols-outlined text-sm align-middle">timer</span>
                    <span id="timer-display">00:00</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-8">

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-20">
            <span class="material-symbols-outlined text-5xl text-slate-600 animate-spin mb-4">progress_activity</span>
            <p class="text-slate-400">Carregando prova...</p>
        </div>

        <!-- Prova Content -->
        <div id="prova-content" class="hidden">
            <!-- Header -->
            <header id="prova-header" class="text-center mb-12">
                <div class="inline-block mb-4">
                    <span class="material-symbols-outlined text-5xl text-aec-pink">quiz</span>
                </div>
                <h1 id="prova-titulo" class="text-3xl font-bold mb-2"></h1>
                <p id="prova-descricao" class="text-slate-400"></p>
                <p class="text-sm text-aec-pink mt-4">
                    Nota mínima: <strong id="nota-minima">7.0</strong> |
                    <span id="total-questoes">0</span> questões
                </p>
            </header>

            <!-- Questions Form -->
            <form id="prova-form" class="space-y-6">
                <div id="questoes-container"></div>

                <button type="submit"
                    class="w-full py-4 bg-gradient-to-r from-aec-pink to-purple-600 rounded-xl font-bold text-white shadow-lg hover:shadow-pink-500/30 transition-all flex items-center justify-center gap-2">
                    <span>ENVIAR RESPOSTAS</span>
                    <span class="material-symbols-outlined">send</span>
                </button>
            </form>
        </div>

        <!-- Result State -->
        <div id="result-state" class="hidden">
            <div id="result-card" class="glass-panel rounded-3xl p-8 text-center max-w-lg mx-auto">
                <div id="result-icon" class="mb-4"></div>
                <h2 id="result-title" class="text-3xl font-bold mb-2"></h2>
                <p id="result-message" class="text-slate-400 mb-6"></p>

                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-slate-800/50 p-4 rounded-xl">
                        <p id="result-acertos" class="text-2xl font-bold text-aec-pink">0</p>
                        <p class="text-xs text-slate-500">Acertos</p>
                    </div>
                    <div class="bg-slate-800/50 p-4 rounded-xl">
                        <p id="result-nota" class="text-2xl font-bold text-white">0.0</p>
                        <p class="text-xs text-slate-500">Nota</p>
                    </div>
                    <div class="bg-slate-800/50 p-4 rounded-xl">
                        <p id="result-pontos" class="text-2xl font-bold text-green-400">+0</p>
                        <p class="text-xs text-slate-500">Pontos</p>
                    </div>
                </div>

                <div id="certificado-section"
                    class="hidden mb-6 p-4 bg-green-500/20 border border-green-500/30 rounded-xl">
                    <p class="text-green-400 flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">workspace_premium</span>
                        Certificado gerado com sucesso!
                    </p>
                </div>

                <a href="dashboard.html"
                    class="inline-block bg-slate-800 hover:bg-slate-700 px-6 py-3 rounded-xl font-medium transition-all">
                    Voltar ao Dashboard
                </a>
            </div>
        </div>
        <!-- Feedback Modal -->
        <div id="feedback-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80" onclick="skipFeedback()"></div>
            <div class="relative glass-panel rounded-3xl p-8 w-full max-w-lg text-center">
                <div class="mb-6">
                    <span class="material-symbols-outlined text-5xl text-yellow-400 mb-2">star</span>
                    <h2 class="text-2xl font-bold text-white">Avalie a Temporada</h2>
                    <p class="text-slate-400 text-sm">O que você achou deste conteúdo?</p>
                </div>

                <div class="flex justify-center gap-2 mb-6" id="star-rating">
                    <button onclick="setRating(1)"
                        class="star-btn text-slate-600 hover:text-yellow-400 transition-colors" data-value="1">
                        <span class="material-symbols-outlined text-4xl">star</span>
                    </button>
                    <button onclick="setRating(2)"
                        class="star-btn text-slate-600 hover:text-yellow-400 transition-colors" data-value="2">
                        <span class="material-symbols-outlined text-4xl">star</span>
                    </button>
                    <button onclick="setRating(3)"
                        class="star-btn text-slate-600 hover:text-yellow-400 transition-colors" data-value="3">
                        <span class="material-symbols-outlined text-4xl">star</span>
                    </button>
                    <button onclick="setRating(4)"
                        class="star-btn text-slate-600 hover:text-yellow-400 transition-colors" data-value="4">
                        <span class="material-symbols-outlined text-4xl">star</span>
                    </button>
                    <button onclick="setRating(5)"
                        class="star-btn text-slate-600 hover:text-yellow-400 transition-colors" data-value="5">
                        <span class="material-symbols-outlined text-4xl">star</span>
                    </button>
                </div>

                <textarea id="feedback-comment" rows="3"
                    class="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-4 text-white resize-none mb-6 placeholder-slate-500"
                    placeholder="Deixe um comentário (opcional)..."></textarea>

                <div class="space-y-3">
                    <button onclick="submitFeedback()"
                        class="w-full bg-aec-pink hover:bg-aec-pinkDark text-white font-bold py-3 rounded-xl transition-all">
                        Enviar Avaliação
                    </button>
                    <button onclick="skipFeedback()" class="text-slate-500 hover:text-white text-sm">
                        Pular
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let userProfile = null;
        let prova = null;
        let questoes = [];
        let startTime = null;
        let currentRating = 0;

        async function init() {
            const user = await getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            userProfile = await getUserProfile();
            if (!userProfile || userProfile.status !== 'aprovado') {
                window.location.href = 'pendente.html';
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const provaId = params.get('id');

            if (!provaId) {
                window.location.href = 'dashboard.html';
                return;
            }

            await loadProva(provaId);
        }

        async function loadProva(id) {
            // Fetch prova
            const { data: provaData, error } = await supabaseClient
                .from('provas')
                .select('*, temporadas(titulo)')
                .eq('id', id)
                .eq('ativa', true)
                .single();

            if (error || !provaData) {
                alert('Prova não encontrada ou não está ativa');
                window.location.href = 'dashboard.html';
                return;
            }

            prova = provaData;

            // Fetch questões
            const { data: questoesData } = await supabaseClient
                .from('questoes')
                .select('*')
                .eq('prova_id', id)
                .order('ordem');

            questoes = questoesData || [];

            if (!questoes.length) {
                alert('Esta prova não tem questões');
                window.location.href = 'dashboard.html';
                return;
            }

            // Shuffle questões
            questoes = questoes.sort(() => Math.random() - 0.5);

            // Fetch user attempts
            const { data: tentativas } = await supabaseClient
                .from('tentativas_prova')
                .select('*')
                .eq('usuario_id', userProfile.id)
                .eq('prova_id', id);

            // Check if already approved or max attempts reached
            const aprovadoTentativa = tentativas?.find(t => t.aprovado);
            if (aprovadoTentativa) {
                // Find the certificate for this season and redirect
                const { data: certificado } = await supabaseClient
                    .from('certificados')
                    .select('id')
                    .eq('usuario_id', userProfile.id)
                    .eq('temporada_id', prova.temporada_id)
                    .single();

                if (certificado) {
                    window.location.href = `certificado.html?id=${certificado.id}`;
                    return;
                }
                // If no certificate found, show completion message
                document.getElementById('loading-state').innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-5xl text-green-400 mb-4">check_circle</span>
                        <h2 class="text-2xl font-bold text-green-400 mb-2">Você já foi aprovado!</h2>
                        <p class="text-slate-400 mb-6">Nota: ${aprovadoTentativa.nota}</p>
                        <a href="dashboard.html" class="bg-slate-800 hover:bg-slate-700 px-6 py-3 rounded-xl font-medium transition-all">
                            Voltar ao Dashboard
                        </a>
                    </div>
                `;
                return;
            }

            if (tentativas && tentativas.length >= 2) {
                alert('Você atingiu o limite de 2 tentativas para esta prova.');
                window.location.href = 'dashboard.html';
                return;
            }

            renderProva();
        }

        function renderProva() {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('prova-content').classList.remove('hidden');

            document.getElementById('prova-titulo').textContent = prova.titulo;
            document.getElementById('prova-descricao').textContent = prova.descricao || prova.temporadas?.titulo || '';
            document.getElementById('nota-minima').textContent = prova.nota_minima;
            document.getElementById('total-questoes').textContent = questoes.length;

            const container = document.getElementById('questoes-container');
            container.innerHTML = questoes.map((q, index) => {
                // Shuffle options
                const opcoes = [...q.opcoes].sort(() => Math.random() - 0.5);

                return `
                    <div class="glass-panel rounded-2xl p-6">
                        <p class="font-semibold text-white flex items-center gap-2 mb-4">
                            <span class="bg-slate-800 text-aec-pink px-2 py-0.5 rounded text-xs">${String(index + 1).padStart(2, '0')}</span>
                            ${q.pergunta}
                        </p>
                        <div class="space-y-3">
                            ${opcoes.map(op => `
                                <label class="flex items-center gap-3 p-4 rounded-xl border border-slate-700 bg-slate-800/30 hover:bg-slate-800/80 hover:border-aec-pink/50 cursor-pointer transition-all group">
                                    <input type="radio" name="q-${q.id}" value="${op.value}" class="accent-aec-pink w-5 h-5" required>
                                    <span class="text-slate-300 text-sm group-hover:text-white">${op.label}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            startTime = Date.now();
            startTimer();
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            const display = document.getElementById('timer-display');
            timerEl.classList.remove('hidden');

            setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const mins = Math.floor(elapsed / 60);
                const secs = elapsed % 60;
                display.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }, 1000);
        }

        document.getElementById('prova-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const respostas = {};
            let acertos = 0;

            for (const q of questoes) {
                const resposta = formData.get(`q-${q.id}`);
                respostas[q.id] = resposta;

                if (resposta === q.resposta_correta) {
                    acertos++;
                }
            }

            // Calculate results
            const nota = (acertos / questoes.length) * 10;
            const aprovado = nota >= prova.nota_minima;
            const pontuacao = aprovado ? acertos * prova.pontos_por_acerto : 0;
            const tempoGasto = Math.floor((Date.now() - startTime) / 1000);

            // Save attempt
            const { data: tentativa, error: tentativaError } = await supabaseClient
                .from('tentativas_prova')
                .insert({
                    usuario_id: userProfile.id,
                    prova_id: prova.id,
                    respostas: respostas,
                    acertos: acertos,
                    total_questoes: questoes.length,
                    nota: nota.toFixed(2),
                    pontuacao: pontuacao,
                    aprovado: aprovado,
                    tempo_gasto_segundos: tempoGasto
                })
                .select()
                .single();

            if (tentativaError) {
                alert('Erro ao salvar resultado');
                return;
            }

            // Update user pontuação
            if (pontuacao > 0) {
                await supabaseClient.rpc('increment_pontuacao', {
                    user_id: userProfile.id,
                    pontos: pontuacao
                }).catch(() => {
                    // Fallback: direct update
                    supabase
                        .from('usuarios')
                        .update({ pontuacao_total: userProfile.pontuacao_total + pontuacao })
                        .eq('id', userProfile.id);
                });
            }

            // Generate certificate if approved
            let certificadoGerado = false;
            if (aprovado) {
                const codigo = generateCertificateCode();
                const { error: certError } = await supabaseClient
                    .from('certificados')
                    .insert({
                        usuario_id: userProfile.id,
                        temporada_id: prova.temporada_id,
                        tentativa_id: tentativa.id,
                        codigo_validacao: codigo,
                        nota: nota.toFixed(2)
                    });

                if (!certError) {
                    certificadoGerado = true;
                }
            }

            // Show results
            showResults(acertos, nota, pontuacao, aprovado, certificadoGerado);
        });

        function showResults(acertos, nota, pontuacao, aprovado, certificadoGerado) {
            document.getElementById('prova-content').classList.add('hidden');
            document.getElementById('result-state').classList.remove('hidden');

            const resultCard = document.getElementById('result-card');

            if (aprovado) {
                resultCard.classList.add('border', 'border-green-500/30');
                document.getElementById('result-icon').innerHTML = `<span class="material-symbols-outlined text-6xl text-green-400">emoji_events</span>`;
                document.getElementById('result-title').textContent = 'Parabéns! Aprovado!';
                document.getElementById('result-title').className = 'text-3xl font-bold mb-2 text-green-400';
                document.getElementById('result-message').textContent = 'Você completou a prova com sucesso!';

                // Show Feedback Modal after short delay
                setTimeout(() => {
                    document.getElementById('feedback-modal').classList.remove('hidden');
                }, 1500);

            } else {
                resultCard.classList.add('border', 'border-red-500/30');
                document.getElementById('result-icon').innerHTML = `<span class="material-symbols-outlined text-6xl text-red-400">sentiment_dissatisfied</span>`;
                document.getElementById('result-title').textContent = 'Não foi dessa vez';
                document.getElementById('result-title').className = 'text-3xl font-bold mb-2 text-red-400';
                document.getElementById('result-message').textContent = `Você precisa de pelo menos ${prova.nota_minima} para aprovação. Revise o conteúdo e tente novamente.`;
            }

            document.getElementById('result-acertos').textContent = `${acertos}/${questoes.length}`;
            document.getElementById('result-nota').textContent = nota.toFixed(1);
            document.getElementById('result-pontos').textContent = `+${pontuacao}`;

            if (certificadoGerado) {
                document.getElementById('certificado-section').classList.remove('hidden');
            }
        }

        // --- Feedback Logic ---

        function setRating(val) {
            currentRating = val;
            const buttons = document.querySelectorAll('.star-btn');

            buttons.forEach(btn => {
                const btnVal = parseInt(btn.dataset.value);
                if (btnVal <= val) {
                    btn.classList.add('text-yellow-400');
                    btn.classList.remove('text-slate-600');
                    btn.querySelector('span').textContent = 'star';
                } else {
                    btn.classList.add('text-slate-600');
                    btn.classList.remove('text-yellow-400');
                    btn.querySelector('span').textContent = 'star'; // Keep full star icon, just change color
                }
            });
        }

        async function submitFeedback() {
            if (!currentRating) {
                alert('Por favor, selecione uma nota de 1 a 5 estrelas.');
                return;
            }

            const comment = document.getElementById('feedback-comment').value;

            const { error } = await supabaseClient.from('avaliacoes_temporada').insert({
                usuario_id: userProfile.id,
                temporada_id: prova.temporada_id,
                nota: currentRating,
                comentario: comment || null
            });

            if (error) {
                console.error('Erro ao enviar feedback:', error);
                alert('Erro ao enviar avaliação.');
                return;
            }

            document.getElementById('feedback-modal').classList.add('hidden');
            showToast('Obrigado pelo seu feedback! ⭐', 'success');

            // Reward 5 points
            await supabaseClient.rpc('increment_pontuacao', {
                user_id: userProfile.id,
                pontos: 5
            }).catch(async () => {
                // Fallback
                const { data: u } = await supabaseClient.from('usuarios').select('pontuacao_total').eq('id', userProfile.id).single();
                if (u) {
                    await supabaseClient.from('usuarios').update({ pontuacao_total: u.pontuacao_total + 5 }).eq('id', userProfile.id);
                }
            });
        }

        function skipFeedback() {
            document.getElementById('feedback-modal').classList.add('hidden');
        }

        init();
    </script>
</body>

</html>