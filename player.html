<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Player | Next Level Podcast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { aec: { blue: '#0032A1', dark: '#001E4B', pink: '#ec4899', pinkDark: '#be185d' } },
                    animation: {
                        'fade-in': 'fadeIn 0.8s ease-out forwards',
                        'slide-up': 'slideUp 0.6s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ec4899;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .gradient-text {
            background: linear-gradient(135deg, #ec4899, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .active-track {
            background: rgba(236, 72, 153, 0.15);
            border-left: 3px solid #ec4899;
        }

        .locked-track {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.2);
        }

        .unlocked {
            animation: unlockPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes unlockPop {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen font-sans overflow-x-hidden">

    <section id="player-view" class="min-h-screen bg-slate-950 flex flex-col">
        <!-- Navbar -->
        <nav class="sticky top-0 z-40 bg-slate-900/90 border-b border-slate-800 backdrop-blur-md">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <a href="dashboard.html"
                        class="flex items-center gap-3 cursor-pointer group hover:bg-slate-800 py-2 px-3 rounded-xl transition-colors">
                        <div class="bg-slate-800 group-hover:bg-aec-pink p-1.5 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-white text-xl">arrow_back</span>
                        </div>
                        <div class="flex flex-col items-start">
                            <span class="font-bold text-sm text-slate-300 group-hover:text-white">Voltar ao
                                Dashboard</span>
                            <span id="temporada-titulo"
                                class="text-[10px] text-aec-pink uppercase tracking-widest font-bold">Next Level</span>
                        </div>
                    </a>

                    <div
                        class="hidden md:flex items-center gap-4 bg-slate-800/50 px-5 py-2 rounded-full border border-slate-700">
                        <span class="text-xs text-slate-400 uppercase font-bold flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">lock_open</span>
                            Progresso
                        </span>
                        <div class="h-1.5 w-32 bg-slate-700 rounded-full overflow-hidden">
                            <div id="nav-progress-bar" class="h-full bg-aec-pink w-0 transition-all duration-500"></div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Sidebar -->
            <aside class="lg:col-span-4 flex flex-col gap-6 h-fit lg:sticky lg:top-24">
                <!-- Player Card -->
                <div
                    class="glass-panel rounded-3xl p-6 shadow-2xl relative overflow-hidden group border border-slate-800">
                    <div class="absolute inset-0 opacity-20">
                        <img id="player-bg"
                            src="https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?q=80&w=2070&auto=format&fit=crop"
                            class="w-full h-full object-cover blur-sm filter brightness-50">
                    </div>

                    <div class="relative z-10 flex flex-col items-center text-center">
                        <div
                            class="relative w-48 h-48 mb-6 rounded-2xl overflow-hidden shadow-2xl border-2 border-slate-600 ring-4 ring-aec-pink/10">
                            <img id="album-art"
                                src="https://images.unsplash.com/photo-1590602847861-f357a9332bbc?q=80&w=1000&auto=format&fit=crop"
                                class="w-full h-full object-cover transition-all duration-500 hover:scale-105">
                        </div>

                        <h2 id="track-title" class="text-xl font-bold text-white mb-1 line-clamp-1">Carregando...</h2>
                        <p id="track-subtitle" class="text-xs text-aec-pink font-bold uppercase tracking-widest mb-6">
                            Podcast</p>

                        <!-- Progress Bar -->
                        <div class="w-full group/scrubber mb-2">
                            <div id="progress-container"
                                class="w-full bg-slate-800 rounded-full h-1.5 cursor-pointer overflow-hidden relative">
                                <div id="progress-bar"
                                    class="bg-gradient-to-r from-aec-pink to-purple-500 h-full w-0 relative">
                                    <div
                                        class="absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-md opacity-0 group-hover/scrubber:opacity-100 transition-opacity">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="w-full flex justify-between text-[10px] text-slate-400 font-mono mb-6">
                            <span id="current-time">0:00</span>
                            <span id="duration">0:00</span>
                        </div>

                        <!-- Controls -->
                        <div class="flex items-center gap-8">
                            <button onclick="prevTrack()" class="text-slate-400 hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-4xl">skip_previous</span>
                            </button>
                            <button id="play-btn" onclick="togglePlay()"
                                class="bg-white text-black rounded-full w-16 h-16 flex items-center justify-center hover:scale-105 hover:bg-aec-pink hover:text-white transition-all shadow-xl shadow-pink-500/20">
                                <span id="play-icon"
                                    class="material-symbols-outlined text-4xl fill-current ml-1">play_arrow</span>
                            </button>
                            <button onclick="nextTrack()" class="text-slate-400 hover:text-white transition-colors">
                                <span class="material-symbols-outlined text-4xl">skip_next</span>
                            </button>
                        </div>
                    </div>
                    <audio id="audio-player"></audio>
                </div>

                <!-- Playlist -->
                <div
                    class="glass-panel rounded-2xl overflow-hidden border border-slate-800 flex flex-col max-h-[500px]">
                    <div
                        class="p-4 bg-slate-900/80 border-b border-slate-800 flex justify-between items-center backdrop-blur-sm sticky top-0 z-20">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">playlist_play</span>
                            Epis贸dios
                        </span>
                        <span id="progress-text"
                            class="text-xs font-bold text-aec-pink bg-aec-pink/10 px-2 py-1 rounded-full">0/0</span>
                    </div>
                    <div id="playlist-container" class="divide-y divide-slate-800 overflow-y-auto"></div>
                </div>
            </aside>

            <!-- Content Area -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                <!-- Content Display -->
                <section id="content-display"
                    class="glass-panel rounded-3xl p-8 min-h-[350px] border border-slate-800 relative overflow-hidden animate-slide-up">
                    <div class="text-center py-12">
                        <span
                            class="material-symbols-outlined text-4xl text-slate-600 mb-4 animate-pulse">headphones</span>
                        <p class="text-slate-400">Selecione um epis贸dio para come莽ar</p>
                    </div>
                </section>

                <!-- Quiz Section (locked initially) -->
                <section id="quiz-section"
                    class="relative rounded-3xl overflow-hidden transition-all duration-700 grayscale opacity-70 cursor-not-allowed">
                    <div id="quiz-lock-overlay"
                        class="absolute inset-0 z-20 bg-slate-900/90 backdrop-blur-sm flex flex-col items-center justify-center text-center p-6 border border-slate-700 rounded-3xl">
                        <div class="bg-slate-800 p-5 rounded-full mb-4 shadow-xl border border-slate-700">
                            <span class="material-symbols-outlined text-5xl text-aec-pink">lock</span>
                        </div>
                        <h3 class="text-2xl font-bold text-white mb-2">Prova Bloqueada</h3>
                        <p class="text-slate-400 text-sm max-w-sm mb-6 leading-relaxed">
                            Complete todos os epis贸dios para liberar a prova desta temporada.
                        </p>
                        <div class="w-full max-w-xs bg-slate-800 rounded-full h-2 border border-slate-700">
                            <div id="lock-progress"
                                class="bg-aec-pink h-full rounded-full w-0 transition-all duration-500 shadow-[0_0_10px_rgba(236,72,153,0.5)]">
                            </div>
                        </div>
                        <p class="mt-2 text-xs text-slate-500 font-mono">Progresso Atual</p>
                    </div>

                    <div
                        class="glass-panel p-8 border border-aec-pink/30 rounded-3xl bg-gradient-to-br from-slate-900 to-slate-950">
                        <div class="flex items-center gap-5 mb-8 border-b border-slate-800 pb-6">
                            <div class="p-4 bg-aec-pink text-white rounded-2xl shadow-lg shadow-pink-900/50">
                                <span class="material-symbols-outlined text-4xl">quiz</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-white">Prova da Temporada</h2>
                                <p class="text-slate-400 text-sm mt-1">Complete para obter seu certificado.</p>
                            </div>
                        </div>

                        <a href="#" id="prova-link"
                            class="block w-full py-4 bg-gradient-to-r from-aec-pink to-purple-600 rounded-xl font-bold text-white text-center shadow-lg hover:shadow-pink-500/30 transition-all">
                            INICIAR PROVA
                        </a>
                    </div>
                </section>
            </div>
        </main>
    </section>

    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/bonus-modules.js"></script>
    <script>
        // State
        let userProfile = null;
        let temporada = null;
        let episodios = [];
        let currentTrackIndex = 0;
        let isPlaying = false;
        let completedTracks = new Set();
        let prova = null;
        let maxTimeReached = 0; // Controle de quanto do 谩udio j谩 foi ouvido

        const audio = document.getElementById('audio-player');

        async function init() {
            // Check auth
            const user = await getUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            userProfile = await getUserProfile();
            if (!userProfile || userProfile.status !== 'aprovado') {
                window.location.href = 'pendente.html';
                return;
            }

            // Get temporada from URL
            const params = new URLSearchParams(window.location.search);
            const temporadaId = params.get('temporada');

            if (!temporadaId) {
                window.location.href = 'dashboard.html';
                return;
            }

            await loadTemporada(temporadaId);
        }

        async function loadTemporada(id) {
            // Fetch temporada
            const { data: temp, error } = await supabaseClient
                .from('temporadas')
                .select('*')
                .eq('id', id)
                .single();

            if (error || !temp) {
                window.location.href = 'dashboard.html';
                return;
            }

            temporada = temp;
            document.getElementById('temporada-titulo').textContent = temporada.titulo;
            document.getElementById('track-subtitle').textContent = temporada.titulo;

            // Fetch epis贸dios
            const { data: eps } = await supabaseClient
                .from('episodios')
                .select('*')
                .eq('temporada_id', id)
                .eq('status', 'publicado')
                .order('ordem', { ascending: true });

            episodios = eps || [];

            if (!episodios.length) {
                document.getElementById('content-display').innerHTML = `
                <div class="text-center py-12">
                    <span class="material-symbols-outlined text-4xl text-slate-600 mb-4">info</span>
                    <p class="text-slate-400">Nenhum epis贸dio publicado nesta temporada</p>
                </div>
            `;
                return;
            }

            // Fetch user progress
            const { data: progresso } = await supabaseClient
                .from('progresso_usuario')
                .select('episodio_id')
                .eq('usuario_id', userProfile.id)
                .eq('completado', true);

            progresso?.forEach(p => completedTracks.add(p.episodio_id));

            // Check for certificate (Season Completed)
            const { data: certificado } = await supabaseClient
                .from('certificados')
                .select('id')
                .eq('usuario_id', userProfile.id)
                .eq('temporada_id', id)
                .single();

            // Check for prova
            const { data: p } = await supabaseClient
                .from('provas')
                .select('id')
                .eq('temporada_id', id)
                .eq('ativa', true)
                .single();

            prova = p;

            if (prova) {
                const provaLink = document.getElementById('prova-link');
                const quizSection = document.getElementById('quiz-section');
                const lockOverlay = document.getElementById('quiz-lock-overlay');

                provaLink.href = `prova.html?id=${prova.id}`;

                if (certificado) {
                    // Season Completed
                    quizSection.classList.remove('grayscale', 'opacity-70', 'cursor-not-allowed');
                    quizSection.classList.add('unlocked', 'border-green-500', 'border-2');
                    lockOverlay.classList.add('hidden'); // Completely hide lock

                    document.querySelector('#quiz-section h2').textContent = 'Temporada Conclu铆da!';
                    document.querySelector('#quiz-section p').textContent = 'Voc锚 j谩 conquistou seu certificado.';
                    provaLink.textContent = 'VER RESULTADO / TENTAR NOVAMENTE';
                    provaLink.classList.remove('from-aec-pink', 'to-purple-600');
                    provaLink.classList.add('from-green-500', 'to-emerald-600');
                }
            }

            renderPlaylist();
            loadTrack(0);

            // Setup audio events
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('ended', handleTrackEnd);
            document.getElementById('progress-container').addEventListener('click', seek);
        }

        function isTrackLocked(index) {
            if (index === 0) return false;
            const prevEpisodio = episodios[index - 1];
            return !completedTracks.has(prevEpisodio.id);
        }

        function renderPlaylist() {
            const container = document.getElementById('playlist-container');
            container.innerHTML = '';

            episodios.forEach((ep, index) => {
                const isLocked = isTrackLocked(index);

                // Unlock quiz check
                checkQuizLock();
                const isCompleted = completedTracks.has(ep.id);
                const isActive = index === currentTrackIndex;

                const div = document.createElement('div');
                let classes = 'p-4 flex items-center justify-between group transition-all border-l-2 border-transparent';

                if (isLocked) {
                    div.className = `${classes} locked-track`;
                } else {
                    div.className = `${classes} cursor-pointer hover:bg-slate-800 ${isActive ? 'active-track bg-slate-800' : ''}`;
                    div.onclick = () => playTrack(index);
                }

                let iconHtml = '';
                if (isLocked) {
                    iconHtml = `<span class="material-symbols-outlined text-sm text-slate-500">lock</span>`;
                } else if (isCompleted) {
                    iconHtml = `<span class="material-symbols-outlined text-sm text-green-500">check_circle</span>`;
                } else if (isActive && isPlaying) {
                    iconHtml = `<span class="material-symbols-outlined text-sm text-aec-pink animate-pulse">equalizer</span>`;
                } else {
                    iconHtml = `<span class="material-symbols-outlined text-sm text-slate-300">play_arrow</span>`;
                }

                div.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-900 border border-slate-700 shadow-inner">
                        ${iconHtml}
                    </div>
                    <div class="flex flex-col">
                        <h4 class="text-sm font-medium ${isActive ? 'text-aec-pink' : 'text-slate-300'} ${isLocked ? 'text-slate-600' : ''}">${ep.titulo}</h4>
                        <span class="text-[10px] text-slate-500">${isLocked ? 'Bloqueado' : formatDuration(ep.duracao_segundos)}</span>
                    </div>
                </div>
            `;
                container.appendChild(div);
            });

            // Update progress display
            const completed = episodios.filter(ep => completedTracks.has(ep.id)).length;
            document.getElementById('progress-text').innerText = `${completed}/${episodios.length}`;
            document.getElementById('nav-progress-bar').style.width = `${(completed / episodios.length) * 100}%`;
            document.getElementById('lock-progress').style.width = `${(completed / episodios.length) * 100}%`;

            // Check quiz unlock
            if (completed === episodios.length) {
                const quizSection = document.getElementById('quiz-section');
                const lockOverlay = document.getElementById('quiz-lock-overlay');
                quizSection.classList.remove('grayscale', 'opacity-70', 'cursor-not-allowed');
                lockOverlay.classList.add('opacity-0', 'pointer-events-none');
                quizSection.classList.add('unlocked');
            }
        }

        function loadTrack(index) {
            if (isTrackLocked(index)) return;

            currentTrackIndex = index;
            const ep = episodios[index];

            if (ep.audio_url) {
                audio.src = ep.audio_url;
                maxTimeReached = 0; // Reseta o controle ao carregar novo epis贸dio
            }

            document.getElementById('track-title').textContent = ep.titulo;
            document.getElementById('album-art').src = ep.imagem_url || 'https://images.unsplash.com/photo-1590602847861-f357a9332bbc?q=80&w=1000&auto=format&fit=crop';
            document.getElementById('player-bg').src = ep.imagem_url || 'https://images.unsplash.com/photo-1598488035139-bdbb2231ce04?q=80&w=2070&auto=format&fit=crop';

            // Show content
            const display = document.getElementById('content-display');
            display.innerHTML = `
            <div class="animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <div class="inline-flex items-center gap-2 px-3 py-1 bg-aec-pink/20 text-aec-pink border border-aec-pink/30 rounded-full text-xs font-bold">
                        <span class="w-2 h-2 rounded-full bg-aec-pink animate-pulse"></span>
                        Epis贸dio ${index + 1}
                    </div>
                    
                    ${ep.material_apoio_url ? `
                        <a href="${ep.material_apoio_url}" target="_blank" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold py-2 px-4 rounded-lg transition-colors border border-slate-700">
                            <span class="material-symbols-outlined text-sm">download</span>
                            ${ep.material_apoio_nome || 'Material de Apoio'}
                        </a>
                    ` : ''}
                </div>

                <h1 class="text-3xl font-bold mb-4">${ep.titulo}</h1>

                ${ep.video_url ? (() => {
                    let videoHtml = '';
                    if (ep.video_url.includes('youtube.com') || ep.video_url.includes('youtu.be')) {
                        const videoId = ep.video_url.split('v=')[1] || ep.video_url.split('/').pop();
                        videoHtml = `
                            <div class="w-full aspect-video rounded-2xl shadow-2xl mb-8 border border-slate-700 overflow-hidden relative">
                                <iframe src="https://www.youtube.com/embed/${videoId.split('&')[0]}?modestbranding=1&rel=0&showinfo=0" class="absolute top-0 left-0 w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>`;
                    } else if (ep.video_url.includes('vimeo')) {
                        const videoId = ep.video_url.split('/').pop();
                        videoHtml = `
                            <div class="w-full aspect-video rounded-2xl shadow-2xl mb-8 border border-slate-700 overflow-hidden relative">
                                <iframe src="https://player.vimeo.com/video/${videoId}" class="absolute top-0 left-0 w-full h-full" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                            </div>`;
                    } else {
                        videoHtml = `
                             <div class="w-full aspect-video rounded-2xl shadow-2xl mb-8 border border-slate-700 overflow-hidden relative bg-slate-900 flex flex-col items-center justify-center">
                                <span class="material-symbols-outlined text-4xl text-slate-500 mb-2">video_library</span>
                                <a href="${ep.video_url}" target="_blank" class="text-aec-pink underline font-medium">Assistir V铆deo Externo</a>
                            </div>`;
                    }
                    return videoHtml;
                })() : ''}

                <div class="prose prose-invert max-w-none">
                    <p class="text-slate-300 leading-relaxed whitespace-pre-wrap">${ep.descricao || 'Sem descri莽茫o dispon铆vel.'}</p>
                </div>
            </div>
        `;

            renderPlaylist();
        }

        function togglePlay() {
            const ep = episodios[currentTrackIndex];

            if (audio.paused) {
                if (ep.audio_url) {
                    audio.play()
                        .then(() => {
                            isPlaying = true;
                            updatePlayButton();
                            renderPlaylist();
                        })
                        .catch(() => {
                            // Simular se o 谩udio n茫o carregar
                            isPlaying = true;
                            updatePlayButton();
                            renderPlaylist();
                            simulatePlay();
                        });
                } else {
                    isPlaying = true;
                    updatePlayButton();
                    renderPlaylist();
                    simulatePlay();
                }
            } else {
                audio.pause();
                isPlaying = false;
                updatePlayButton();
                renderPlaylist();
                if (window.simTimer) clearInterval(window.simTimer);
            }
        }

        function playTrack(index) {
            if (isTrackLocked(index)) return;
            loadTrack(index);
            setTimeout(togglePlay, 100);
        }

        function prevTrack() {
            if (currentTrackIndex > 0 && !isTrackLocked(currentTrackIndex - 1)) {
                playTrack(currentTrackIndex - 1);
            }
        }

        function nextTrack() {
            if (currentTrackIndex < episodios.length - 1 && !isTrackLocked(currentTrackIndex + 1)) {
                playTrack(currentTrackIndex + 1);
            }
        }

        async function handleTrackEnd() {
            const ep = episodios[currentTrackIndex];
            completedTracks.add(ep.id);

            // Save progress to database
            const { error } = await supabaseClient.from('progresso_usuario').upsert({
                usuario_id: userProfile.id,
                episodio_id: ep.id,
                completado: true,
                tempo_assistido: ep.duracao_segundos || 0
            }, { onConflict: 'usuario_id,episodio_id' });

            if (error) console.error('Erro ao salvar progresso:', error);

            //  Verificar se desbloqueou algum m贸dulo b么nus
            checkBonusUnlock(ep.id);

            renderPlaylist();

            if (currentTrackIndex < episodios.length - 1) {
                setTimeout(() => playTrack(currentTrackIndex + 1), 1000);
            } else {
                isPlaying = false;
                updatePlayButton();
                document.getElementById('quiz-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Verifica se o epis贸dio completado desbloqueia m贸dulos b么nus
        async function checkBonusUnlock(episodioId) {
            try {
                // Buscar template_id do epis贸dio completado
                const { data: epData } = await supabaseClient
                    .from('episodios')
                    .select('template_id')
                    .eq('id', episodioId)
                    .single();

                if (!epData?.template_id) return;

                const templateId = epData.template_id;
                const modules = window.BONUS_MODULES || [];

                // Encontrar m贸dulos b么nus desbloqueados por este epis贸dio
                const unlocked = modules.filter(m => m.episodio_prerequisito === templateId);

                if (unlocked.length > 0) {
                    unlocked.forEach(m => {
                        setTimeout(() => {
                            showToast(` M贸dulo B么nus desbloqueado: "${m.nome}"! Acesse em B么nus para praticar.`, 'success');
                        }, 1500);
                    });
                    console.log(' M贸dulos desbloqueados:', unlocked.map(m => m.codigo));
                }
            } catch (err) {
                console.error('Erro ao verificar desbloqueio b么nus:', err);
            }
        }

        function updatePlayButton() {
            document.getElementById('play-icon').textContent = isPlaying ? 'pause' : 'play_arrow';
        }

        function updateProgress() {
            const dur = audio.duration || episodios[currentTrackIndex]?.duracao_segundos || 0;
            const cur = audio.currentTime;
            const pct = dur > 0 ? (cur / dur) * 100 : 0;

            // Atualiza tempo m谩ximo alcan莽ado
            if (cur > maxTimeReached) {
                maxTimeReached = cur;
            }

            document.getElementById('progress-bar').style.width = `${pct}%`;
            document.getElementById('current-time').textContent = formatDuration(cur);
            document.getElementById('duration').textContent = formatDuration(dur);
        }

        function seek(e) {
            const rect = this.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const dur = audio.duration || episodios[currentTrackIndex]?.duracao_segundos || 0;

            if (dur > 0) {
                const targetTime = (clickX / rect.width) * dur;

                //  BLOQUEIO: Permite apenas voltar, NO permite avan莽ar
                if (targetTime <= maxTimeReached) {
                    audio.currentTime = targetTime;
                    document.getElementById('progress-bar').style.width = `${(clickX / rect.width) * 100}%`;
                } else {
                    // Mostra feedback visual de bloqueio
                    showToast('锔 Voc锚 precisa ouvir o podcast completo sem pular!', 'warning');
                }
            }
        }

        function formatDuration(s) {
            if (!s || isNaN(s)) return '0:00';
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' + sec : sec}`;
        }

        function checkQuizLock() {
            if (!prova) return;
            const quizSection = document.getElementById('quiz-section');
            const lockOverlay = document.getElementById('quiz-lock-overlay');

            // Check if certificate already exists (handled in init)
            if (quizSection.classList.contains('unlocked')) return;

            // Check if all episodes are completed
            if (episodios.length > 0 && episodios.every(ep => completedTracks.has(ep.id))) {
                quizSection.classList.remove('grayscale', 'opacity-70', 'cursor-not-allowed');
                lockOverlay.classList.add('hidden');
            } else {
                // Ensure locked if not complete (and not certificated)
                quizSection.classList.add('grayscale', 'opacity-70', 'cursor-not-allowed');
                lockOverlay.classList.remove('hidden');
            }
        }

        let simTimer;
        function simulatePlay() {
            if (simTimer) clearInterval(simTimer);
            simTimer = setInterval(() => {
                if (!isPlaying) return;

                const bar = document.getElementById('progress-bar');
                let w = parseFloat(bar.style.width) || 0;
                w += 0.5;
                bar.style.width = `${w}%`;

                const dur = episodios[currentTrackIndex]?.duracao_segundos || 60;
                const cur = (w / 100) * dur;
                document.getElementById('current-time').textContent = formatDuration(cur);
                document.getElementById('duration').textContent = formatDuration(dur);

                if (w >= 100) {
                    clearInterval(simTimer);
                    handleTrackEnd();
                }
            }, 100);
        }

        // Inicializa eventos do player
        audio.ontimeupdate = updateProgress;
        audio.onended = handleTrackEnd;
        audio.onloadedmetadata = () => {
            updateProgress();
            maxTimeReached = 0; // Garante reset ao carregar novo 谩udio
        };

        // Adiciona evento de seek com bloqueio
        document.getElementById('progress-container').onclick = seek;

        //  BLOQUEIO EXTRA: Impede avan莽o por teclado (setas)
        audio.addEventListener('seeking', function () {
            if (audio.currentTime > maxTimeReached) {
                audio.currentTime = maxTimeReached;
                showToast('锔 Voc锚 n茫o pode avan莽ar! Ou莽a o podcast completo.', 'warning');
            }
        });

        init();
    </script>
</body>

</html>