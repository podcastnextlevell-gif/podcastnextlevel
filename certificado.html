<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Certificado | Next Level Podcast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"
        rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif']
                    },
                    colors: { aec: { blue: '#0032A1', dark: '#001E4B', pink: '#ec4899', pinkDark: '#be185d' } }
                }
            }
        }
    </script>
    <style>
        @media print {
            @page {
                size: landscape;
                margin: 0;
            }

            body {
                -webkit-print-color-adjust: exact;
            }

            .no-print {
                display: none !important;
            }
        }

        .certificate-bg {
            background-image: url('https://images.unsplash.com/photo-1629814596131-b8733979844c?q=80&w=2000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }

        .gold-border {
            border-image: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c) 1;
        }

        .gold-text {
            background: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>

<body class="bg-slate-900 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Actions Bar -->
    <div class="fixed top-4 right-4 flex gap-4 no-print z-50">
        <a href="dashboard.html"
            class="bg-slate-800 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-700 transition-colors">
            <span class="material-symbols-outlined">arrow_back</span> Voltar
        </a>
        <button onclick="window.print()"
            class="bg-aec-pink text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-aec-pinkDark transition-colors shadow-lg shadow-pink-500/30">
            <span class="material-symbols-outlined">print</span> Imprimir / PDF
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="text-center text-white">
        <span class="material-symbols-outlined text-4xl animate-spin mb-2">progress_activity</span>
        <p>Gerando Certificado...</p>
    </div>

    <!-- Error State -->
    <div id="error"
        class="hidden text-center text-red-400 bg-red-900/20 p-8 rounded-2xl border border-red-900/50 max-w-md">
        <span class="material-symbols-outlined text-4xl mb-2">error</span>
        <h2 class="text-xl font-bold mb-2">Certificado não encontrado</h2>
        <p id="error-msg" class="text-sm">Verifique se o link está correto.</p>
    </div>

    <!-- Certificate Container (Landscape A4 ratio roughly) -->
    <div id="certificate"
        class="hidden bg-white text-slate-900 w-[1123px] h-[794px] relative shadow-2xl overflow-hidden">

        <!-- Border Design -->
        <div class="absolute inset-4 border-2 border-slate-200"></div>
        <div class="absolute inset-6 border-8 border-double border-slate-900"></div>

        <!-- Corner Ornaments (CSS shapes or SVGs could be better, keeping simple) -->
        <div class="absolute top-6 left-6 w-16 h-16 border-t-8 border-l-8 border-slate-900"></div>
        <div class="absolute top-6 right-6 w-16 h-16 border-t-8 border-r-8 border-slate-900"></div>
        <div class="absolute bottom-6 left-6 w-16 h-16 border-b-8 border-l-8 border-slate-900"></div>
        <div class="absolute bottom-6 right-6 w-16 h-16 border-b-8 border-r-8 border-slate-900"></div>

        <!-- Content -->
        <div class="absolute inset-0 flex flex-col items-center justify-center text-center p-20 z-10">

            <!-- Header -->
            <div class="mb-8">
                <div class="flex items-center justify-center gap-3 mb-2">
                    <span class="material-symbols-outlined text-4xl text-aec-pink">podcasts</span>
                    <span class="font-bold text-3xl tracking-tight uppercase">Next <span
                            class="text-aec-pink">Level</span> Podcast</span>
                </div>
                <p class="text-sm uppercase tracking-[0.3em] text-slate-500">Certificado de Excelência</p>
            </div>

            <h1 class="font-serif text-6xl font-bold text-slate-900 mb-8 italic">Certificado de Conclusão</h1>

            <p class="text-xl text-slate-600 mb-6">Certificamos que</p>

            <!-- Student Name -->
            <div class="relative mb-8 px-12 pb-2 border-b-2 border-slate-300 min-w-[500px]">
                <h2 id="student-name" class="font-serif text-4xl font-bold text-slate-900 capitalize"></h2>
            </div>

            <p class="text-xl text-slate-600 mb-4 max-w-3xl leading-relaxed">
                concluiu com êxito a temporada <strong id="course-name" class="text-slate-900"></strong>,
                demonstrando domínio nos conceitos apresentados,
                com carga horária estimada de <strong id="hours"></strong> horas.
            </p>

            <div class="mt-12 w-full flex justify-center items-end gap-16 px-20">
                <!-- Seal -->
                <div class="mb-2">
                    <div
                        class="w-32 h-32 rounded-full border-4 border-slate-900 flex items-center justify-center bg-slate-50 relative">
                        <div class="absolute inset-1 border border-slate-300 rounded-full"></div>
                        <div class="text-center transform -rotate-12">
                            <span class="material-symbols-outlined text-4xl text-aec-pink mb-1">workspace_premium</span>
                            <p class="text-[10px] font-bold uppercase tracking-widest">Aprovado</p>
                            <p class="text-[8px] text-slate-500">Com distinção</p>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <div class="w-64 border-b border-slate-900 mb-2 mx-auto"></div>
                    <p class="font-bold text-sm uppercase">Samuel Rosa</p>
                    <p class="text-xs text-slate-500">Superintendente de Qualidade</p>
                </div>
            </div>

            <!-- Data de Emissão -->
            <div class="mt-8 text-center">
                <p id="issue-date"
                    class="font-serif text-lg mb-2 border-b border-slate-900 pb-2 inline-block min-w-[200px]"></p>
                <p class="text-xs text-slate-500 uppercase tracking-wider">Data de Emissão</p>
            </div>

            <!-- Footer / Verification -->
            <div class="absolute bottom-8 left-0 right-0 text-center">
                <p class="text-[10px] text-slate-400 font-mono uppercase tracking-widest">
                    Código de Validação: <span id="cert-code" class="text-slate-600 font-bold"></span>
                </p>
                <p class="text-[8px] text-slate-300 mt-1">Este certificado atesta a conclusão dos requisitos acadêmicos
                    propostos.</p>
            </div>
        </div>

        <!-- Background watermark -->
        <div class="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none">
            <span class="material-symbols-outlined text-[500px]">podcasts</span>
        </div>
    </div>

    <script src="js/supabase-config.js"></script>
    <script>
        async function init() {
            const params = new URLSearchParams(window.location.search);
            const certId = params.get('id');

            if (!certId) {
                showError('ID do certificado não fornecido.');
                return;
            }

            try {
                // Fetch Certificate Data with relations
                const { data: cert, error } = await supabaseClient
                    .from('certificados')
                    .select('*, temporadas(titulo, ordem), usuarios(nome_completo, nickname)')
                    .eq('id', certId)
                    .single();

                if (error || !cert) throw error || new Error('Certificado não encontrado');

                // Render Data
                const studentName = cert.nome_aluno || cert.usuarios?.nome_completo || cert.usuarios?.nickname || 'Aluno';

                document.getElementById('student-name').textContent = studentName;
                document.getElementById('course-name').textContent = cert.temporadas?.titulo || 'Curso Next Level';
                document.getElementById('hours').textContent = cert.carga_horaria || 10;

                // Format Date
                const date = new Date(cert.created_at || cert.data_conclusao);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('issue-date').textContent = date.toLocaleDateString('pt-BR', options);

                document.getElementById('cert-code').textContent = cert.codigo_validacao || cert.id;

                // Show Certificate
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('certificate').classList.remove('hidden');

                // Update tab title
                document.title = `Certificado - ${studentName}`;

            } catch (err) {
                console.error(err);
                showError('Não foi possível carregar os dados do certificado.');
            }
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('error-msg').textContent = msg;
        }

        init();
    </script>
</body>

</html>